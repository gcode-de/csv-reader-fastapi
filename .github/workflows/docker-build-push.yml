name: Docker Build & Push (backend/frontend)

on:
  push:
    branches: ["main", "dev"]
  workflow_dispatch:

env:
  # DockerHub repository in the form "namespace/repo" e.g. "yourname/csv-viewer"
  DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_REPO }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - component: backend
            context: .
            dockerfile: Dockerfile
            tagSuffix: backend
          - component: frontend
            context: packages/frontend
            dockerfile: packages/frontend/Dockerfile
            tagSuffix: frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sanity check build context (backend/frontend assets)
        run: |
          echo "Component: ${{ matrix.component }}" && pwd
          ls -la .
          if [ "${{ matrix.component }}" = "backend" ]; then
            ls -la packages/backend || true
            ls -la packages/backend/app || true
            test -f packages/backend/requirements.txt
            test -f docker-entrypoint.sh
          else
            ls -la packages/frontend || true
            ls -la packages/frontend/src || true
            test -f packages/frontend/Dockerfile
          fi

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub (main only)
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and conditional push (${{ matrix.component }})
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: ${{ github.ref == 'refs/heads/main' }}
          tags: |
            ${{ env.DOCKERHUB_REPO }}:${{ matrix.tagSuffix }}-latest
            ${{ env.DOCKERHUB_REPO }}:${{ matrix.tagSuffix }}-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "Component: ${{ matrix.component }}" >> $GITHUB_STEP_SUMMARY
          echo "Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Pushed: ${{ github.ref == 'refs/heads/main' }}" >> $GITHUB_STEP_SUMMARY
          echo "Image tags:" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.DOCKERHUB_REPO }}:${{ matrix.tagSuffix }}-latest" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.DOCKERHUB_REPO }}:${{ matrix.tagSuffix }}-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
